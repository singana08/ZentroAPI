trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  apiProject: 'HaluluAPI.csproj'   # your project file
  artifactName: 'drop'
  webAppName: 'api-sing-serv'      # your App Service name
  azureSubscription: 'Azure-Sub-Conn' # your service connection name

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          - task: UseDotNet@2
            inputs:
              packageType: 'sdk'
              version: '8.x'   # adjust if youâ€™re targeting .NET 6/7
          - task: DotNetCoreCLI@2
            inputs:
              command: 'restore'
              projects: '$(apiProject)'
          - task: DotNetCoreCLI@2
            inputs:
              command: 'build'
              projects: '$(apiProject)'
              arguments: '--configuration $(buildConfiguration)'
          - task: DotNetCoreCLI@2
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: '$(apiProject)'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
              zipAfterPublish: true
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: '$(artifactName)'
              publishLocation: 'Container'

  - stage: Deploy
    dependsOn: Build
    jobs:
      - job: Deploy
        steps:
          - download: current
            artifact: '$(artifactName)'
          - task: AzureWebApp@1
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: '$(webAppName)'
              package: '$(Pipeline.Workspace)/$(artifactName)/**/*.zip'